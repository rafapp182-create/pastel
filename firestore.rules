
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---

    function isSignedIn() {
      return request.auth != null;
    }

    // Busca o papel do usuário na coleção 'users'
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isSignedIn() && getRole() == 'admin';
    }

    function isCaixa() {
      return isSignedIn() && getRole() == 'caixa';
    }

    function isCozinha() {
      return isSignedIn() && getRole() == 'cozinha';
    }

    function isCustomer() {
      return isSignedIn() && getRole() == 'customer';
    }

    function isStaff() {
      return isAdmin() || isCaixa() || isCozinha();
    }

    // --- REGRAS POR COLEÇÃO ---

    // Usuários: Perfis e permissões
    match /users/{userId} {
      // Qualquer funcionário logado pode ver seu próprio perfil ou um Admin pode ver todos
      allow get: if isSignedIn();
      allow list: if isAdmin();
      // Criação: O próprio usuário ao se registrar ou um Admin
      allow create: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      // O próprio usuário pode atualizar seu perfil (endereço, whatsapp)
      allow update: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      // Apenas Admin pode deletar usuários
      allow delete: if isAdmin();
    }

    // Produtos: Cardápio da pastelaria
    match /products/{productId} {
      // Público: Clientes precisam ver o cardápio
      allow read: if true;
      // Apenas Admin e Caixa podem gerenciar o estoque/produtos
      allow write: if isAdmin() || isCaixa();
    }

    // Pedidos: O coração da operação
    match /orders/{orderId} {
      // Funcionários podem ler todos os pedidos, clientes apenas os seus
      allow read: if isStaff() || (isSignedIn() && resource.data.customerId == request.auth.uid);
      // Admin, Caixa e Clientes criam pedidos
      allow create: if isAdmin() || isCaixa() || isCustomer();
      // Atualização: 
      // - Cozinha: Apenas para mudar status (preparo/finalizado)
      // - Caixa/Admin: Para pagamentos e edições
      allow update: if isStaff();
      // Apenas Admin pode deletar pedidos (cancelamento crítico)
      allow delete: if isAdmin();
    }

    // Mesas: Gestão de ocupação
    match /tables/{tableId} {
      allow read: if isStaff();
      // Apenas Admin e Caixa abrem/fecham mesas
      allow write: if isAdmin() || isCaixa();
    }

    // Sessões de Caixa: Abertura e fechamento de turno
    match /sessions/{sessionId} {
      // Apenas Admin e Caixa acessam dados financeiros de sessão
      allow read, write: if isAdmin() || isCaixa();
    }

    // Configurações Globais (Banner, WhatsApp, etc)
    match /settings/{settingId} {
      // Público: Clientes precisam ver o banner e saber o WhatsApp
      allow read: if true;
      // Apenas Admin e Caixa podem alterar configurações
      allow write: if isAdmin() || isCaixa();
    }

    // Carrinhos: Persistência de itens por usuário
    match /carts/{userId} {
      // O próprio usuário pode ler e escrever seu carrinho, Admin também pode ver
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
  }
}
